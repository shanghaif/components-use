(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-3415"],{21:function(e,t){},22:function(e,t){},23:function(e,t){},MiJ8:function(e,t,a){"use strict";a.r(t);var n=a("FyfS"),l=a.n(n),r=a("gDS+"),s=a.n(r),o=a("v0iw"),i=a.n(o),c=a("EUZL"),d=a.n(c),h=a("t3Un");var u={name:"bulkImport",data:function(){return{isGetInfo:!0,isVerify:!0,isInfo:!0,state:"无状态",num:1,file:[],headArr:[{en:"tq",ch:"台区名称",ex:"广东南利嘉投资有限公司（小区1）"},{en:"yhabh",ch:"用户编号",ex:"0305420166778469,用户编号不能相同"},{en:"yhmc",ch:"用户名称",ex:"南澳县南利嘉物业管理有限公司"},{en:"vcaddr_web",ch:"集中器地址",ex:"集中器地址为12位,集中器地址不能相同"},{en:"addr_web",ch:"电能表地址",ex:"电表地址为12位,电表地址不能相同"},{en:"pn",ch:"PN值",ex:"0-2000,同一个集中器pn不能相同"},{en:"yhlb",ch:"用户类别",ex:"[公变普通用户][公变大客户][专变用户]"},{en:"cblx",ch:"通道类型",ex:"[虚拟通道][物理通道]"},{en:"deveui",ch:"采集器编号",ex:"c4c13b8fc4a39b0c"},{en:"appeui",ch:"应用编号",ex:"c4cd82096a4837c1"},{en:"yhdz",ch:"用户地址",ex:"广东省汕头市南澳县云澳镇南利嘉银都华轩商铺"},{en:"zcbh",ch:"资产编号",ex:"03001SF00000271700107078"},{en:"sb",ch:"设备类别",ex:"电能表"},{en:"sblx",ch:"设备类型",ex:"[单相电子式电能表][三相电子式电能表]"},{en:"sccj",ch:"生产厂家",ex:"生产厂家"},{en:"ccbh",ch:"出厂编号",ex:"03001SF00000251700249151"},{en:"txfs",ch:"通信方式",ex:"通信方式"},{en:"txgw",ch:"通信规约",ex:"DL/T645"},{en:"ljdz",ch:"逻辑地址",ex:"逻辑地址"},{en:"dbmm",ch:"远程控制密码",ex:"远程控制密码"},{en:"btl",ch:"波特率",ex:"2"},{en:"zhbl",ch:"综合倍率",ex:"综合倍率"},{en:"eddy",ch:"额定电压",ex:"额定电压"},{en:"bddy",ch:"标定电压",ex:"标定电压"},{en:"zqd",ch:"准确度",ex:"准确度"},{en:"bddl",ch:"到货批次号",ex:"标定电流"},{en:"tysj",ch:"投运时间",ex:"投运时间"},{en:"cbqd",ch:"抄表区段",ex:"抄表区段"},{en:"xl",ch:"线路",ex:"线路"},{en:"cz",ch:"厂站",ex:"厂站"},{en:"jlzzfl",ch:"计量装置分类",ex:"计量装置分类"},{en:"jlfs",ch:"计量方式",ex:"低供低计"},{en:"zfbbz",ch:"主副表标志",ex:"主副表标志"},{en:"jldbh",ch:"计量点编号",ex:"1111111129145564"},{en:"jldwz",ch:"计量点位置",ex:"用户测试"},{en:"jlddz",ch:"计量点地址",ex:"计量点地址"},{en:"scjyrq",ch:"上次检验日期",ex:"上次检验日期"},{en:"jlbx",ch:"计量表箱(柜)",ex:"计量表箱(柜)"},{en:"xgwzh",ch:"箱(柜)位置号",ex:"箱(柜)位置号"},{en:"zzjg",ch:"组织架构",ex:"组织架构"}],sum:0,abnormal:0,form:{gddw:"",gddws:[],upload:"",iserr:!1},tableData:[],OIData:[],tableloading:!1,OIloading:!1,multipleSelection:[]}},created:function(){this.getGddw(),this.getState()},methods:{Parse:function(){var e=i.a.Object.extend("tmp_csv");return new i.a.Query(e)},handleSelectionChange:function(e){this.multipleSelection=e},derive_tmp:function(){for(var e=[],t=[],a=0;a<this.headArr.length;a++)e.push(this.headArr[a].ch);e.push("组织架构");for(var n=0;n<this.headArr.length;n++)t.push(this.headArr[n].ex);t.push("示例：南澳后宅供电所");var l=d.a.utils.aoa_to_sheet([e,t]),r=d.a.utils.book_new();d.a.utils.book_append_sheet(r,l,"Sheet1"),d.a.writeFile(r,"模板.xlsx")},getGddw:function(){var e=this,t=i.a.Object.extend("Department"),a=new i.a.Query(t);a.notEqualTo("org_type","集中器"),a.select("name"),a.find().then(function(t){for(var a=0;a<t.length;a++){var n={};n.value=t[a].id,n.label=t[a].attributes.name,e.form.gddws.push(n)}})},clear:function(){this.OIData=[]},getFile:function(){this.$refs.file.click()},handleFileChange:function(e){this.file=e.target.files[0],this.form.upload=this.file.name;var t=this.file.name.lastIndexOf("."),a=this.file.name.substr(t);".xls"!=a&&".xlsx"!=a&&".csv"!=a&&(this.$message.error("只支持xls、xlsx、csv后缀名的文件，请重新选择文件"),this.form.upload="")},upload:function(e){this.tableloading=!0,this.tableData=[],this.importf(e,!1,void 0)},importf:function(e,t,a){var n=this;if(""!=this.form.upload)if(""!=this.form.gddw){this.sum=0;var l=e,r=new FileReader;r.onload=function(e){var l=e.target.result;a=t?d.a.read(btoa(n.fixdata(l)),{type:"base64"}):d.a.read(l,{type:"binary"});for(var r=JSON.parse(s()(d.a.utils.sheet_to_json(a.Sheets[a.SheetNames[0]],{blankrows:!0,defval:""}))),o=function(e){for(var t={others:{}},a=0,l=0;l<n.form.gddws.length;l++)n.form.gddws[l].value==n.form.gddw&&(t.organization=n.form.gddws[l].label);for(var s in r[e]){var o=n.headArr[a].en;"addr_web"==o||"vcaddr_web"==o||"deveui"==o||"appeui"==o||"pn"==o||"yhabh"==o?t[o]=String(r[e][s]):t.others[o]=String(r[e][s]),a++}(function(e){return Object(h.a)({url:"/yhgx/transaction/add",method:"post",data:{addr:e.addr_web,appeui:e.appeui,deveui:e.deveui,num:e.num,organization:e.organization,others:e.others,pn:e.pn,vcaddr:e.vcaddr_web,yhabh:e.yhabh}})})(t).then(function(t){0==t.code&&(n.$message({message:"上传成功！",type:"success"}),e==r.length-1&&(n.getTmpData(),n.getState()))}).catch(function(e){n.$message.error("上传失败，请确认当前状态！")})},i=0;i<r.length;i++)o(i)},t?r.readAsArrayBuffer(l):r.readAsBinaryString(l)}else this.$message({message:"请选择供电单位",type:"warning"});else this.$message({message:"请选择要上传的文件",type:"warning"})},fixdata:function(e){for(var t="",a=0,n=10240;a<e.byteLength/n;++a)t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(a*n,a*n+n)));return t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(a*n)))},getTmpData:function(){var e=this,t=this.Parse();t.ascending("-createdAt"),t.find().then(function(t){for(var a=0;a<t.length;a++){var n={},l=t[a].attributes;for(var r in n.gddw=l.organization,n.num=a+1,n.addr_web=l.addr,n.vcaddr_web=l.vcaddr,n.appeui=l.appeui,n.deveui=l.deveui,n.pn=l.pn,n.yhabh=l.yhabh,l.others)n[r]=l.others[r];e.tableData.push(n),e.sum++}e.tableloading=!1,e.isGetInfo=!1})},handleClickRoll:function(){var e=this;(function(e){return Object(h.a)({url:"/yhgx/transaction/rollback",method:"post",data:{data:e}})})().then(function(t){0==t.code&&(e.$message({message:"数据回滚成功，数据已改变，回到初始状态！",type:"success"}),e.tableData=[],e.OIData=[],e.isGetInfo=!0,e.isInfo=!0,e.num=1,e.sum=0,e.getState())}).catch(function(t){e.$message.error("回滚失败，请重试！")})},delete:function(e,t,a){var n=this,l=this.Parse();l.equalTo(e,t),l.find().then(function(e){var t=e[0].id;l.get(t).then(function(e){e.destroy().then(function(e){n.$message({message:"删除成功！",type:"success"}),a&&(n.tableData=[],n.getTmpData())}).catch(function(e){n.$message.error("删除失败！")})})})},deleteRow:function(e,t){this.delete("addr",t[e].addr_web,!0),this.form.iserr=!1},handleClickDel:function(){var e=this.multipleSelection,t=!1;if(e){for(var a=0;a<e.length;a++)a==e.length-1&&(t=!0),this.delete("addr",e[a].addr_web,t);this.form.iserr=!1}},handleClickVerify:function(){var e=this;this.OIData=[];for(var t=document.querySelectorAll(".table .el-table__body-wrapper .el-table__row"),a=0;a<t.length;a++)t[a].style.color="#606266";(function(e){return Object(h.a)({url:"/yhgx/transaction/check",method:"post",data:{data:e}})})().then(function(a){if(0==a.code){e.$message({message:"校验中！",type:"success"});var n=setInterval(function(){if(e.getState(),"校验失败"==e.state){e.$message.error("校验失败！"),clearInterval(n),e.isInfo=!1;var a=e.Parse();a.select("error"),a.ascending("-createdAt"),a.find().then(function(a){e.OIData.push({num:e.num,oper:"数据上传",errRow:"",errCell:"",OI:"上传"+e.sum+"条",handlers:a.user,time:(new Date).toLocaleString()});for(var n=0;n<a.length;n++){if("{}"!=s()(a[n].attributes.error)){e.num++,e.abnormal++;var l={},r=a[n].attributes.error,o="";for(var i in l.num=e.num,l.oper="数据校验",l.errRow="第"+(n+1)+"行",l.errCell="",r)o+=r[i]+" | ";l.OI=o,l.handlers=a.user,l.time=(new Date).toLocaleString(),e.OIData.push(l),t[n].style.color="#f00"}n==a.length-1&&(e.num++,e.OIData.push({num:e.num,oper:"数据验证(汇总)",errRow:"",errCell:"",OI:"校验完成"+e.sum+"条,"+e.abnormal+"条存在异常",handlers:a.user,time:(new Date).toLocaleString()}))}})}else"校验成功"==e.state&&(clearInterval(n),e.isVerify=!1,e.$message({message:"校验成功！",type:"success"}))},1e3)}}).catch(function(t){e.$message.error("校验发送错误！")})},handleClickImport:function(){var e=this;(function(e){return Object(h.a)({url:"/yhgx/transaction/commit",method:"post",data:{data:e}})})().then(function(t){0==t.code&&(e.$message({message:"导入成功！",type:"success"}),e.isVerify=!0,e.isGetInfo=!0)}).catch(function(t){e.$message.error("导入出错！")})},getState:function(){var e=this;Object(h.a)({url:"/yhgx/transaction/state",method:"get"}).then(function(t){"idle"==t.state?e.state="空闲":"load"==t.state?e.state="加载":"checking"==t.state?e.state="校验中":"check_fail"==t.state?e.state="校验失败":"check_success"==t.state?e.state="校验成功":e.state="提交成功"})},handleChangeUnusual:function(){if(this.form.iserr)for(var e=document.querySelectorAll(".table .el-table__body-wrapper .el-table__row"),t=document.querySelectorAll(".table .el-table__fixed-right .el-table__row"),a=0;a<e.length;a++)"color: rgb(96, 98, 102);"==e[a].getAttribute("style")&&(e[a].style.display="none",t[a].style.display="none");else this.tableData=[],this.getTmpData()},handleClickBackups:function(){var e=this;this.Parse().find().then(function(t){for(var a=JSON.parse(s()(t)),n=0;n<a.length;n++)for(var l in console.log(a[n].others),a[n].others)a[n][l]=a[n].others[l];e.derive(a,{yhabh:"用户编号",yhmc:"用户名称",vcaddr_web:"集中器地址",addr_web:"电能表地址",pn:"PN值",yhlb:"用户类别",cblx:"通道类型",deveui:"采集器编号",appeui:"应用编号",yhdz:"用户地址",zcbh:"资产编号",sb:"设备类别",sblx:"设备类型",sccj:"生产厂家",ccbh:"出厂编号",txfs:"通信方式",txgw:"通信规约",ljdz:"逻辑地址",dbmm:"远程控制密码",btl:"波特率",zhbl:"综合倍率",eddy:"额定电压",bddl:"标定电流",zqd:"准确度",dhpc:"到货批次号",tysj:"投运时间",cbqd:"抄表区段",xl:"线路",cz:"厂站",jlzzfl:"计量装置分类",jlfs:"计量方式",zfbbz:"主副表标志",jldbh:"计量点编号",jldwz:"计量点位置",jlddz:"计量点地址",scjyrq:"上次检验日期",jlbx:"计量表箱(柜)",xgwzh:"箱(柜)位置号"},"数据备份")})},handleClickRecord:function(){},derive:function(e,t,a){var n=[[]],r=0;for(var s in t)n[0][r]=t[s],r++;r=null;var o=!0,i=!1,c=void 0;try{for(var h,u=l()(e);!(o=(h=u.next()).done);o=!0){var f=h.value,m=[];for(var p in t)m.push(f[p]);n.push(m)}}catch(e){i=!0,c=e}finally{try{!o&&u.return&&u.return()}finally{if(i)throw c}}var b=d.a.utils.json_to_sheet(n,{skipHeader:!0}),v=d.a.utils.book_new();d.a.utils.book_append_sheet(v,b,"Sheet1"),d.a.writeFile(v,a+".xlsx")}}},f=(a("xg5B"),a("KHd+")),m=Object(f.a)(u,function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{attrs:{id:"bulkImport"}},[a("div",{staticClass:"content"},[a("div",[a("el-form",{staticClass:"demo-form-inline",attrs:{inline:!0,size:"small ",model:e.form},nativeOn:{submit:function(e){e.preventDefault()}}},[a("div",[a("el-form-item",[a("el-button",{attrs:{type:"primary"},on:{click:e.derive_tmp}},[e._v("模板下载")])],1),e._v(" "),a("el-form-item",{attrs:{label:"供电单位"}},[a("el-select",{attrs:{placeholder:"请选择供电单位"},model:{value:e.form.gddw,callback:function(t){e.$set(e.form,"gddw",t)},expression:"form.gddw"}},e._l(e.form.gddws,function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}))],1),e._v(" "),a("input",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],ref:"file",attrs:{type:"file"},on:{change:function(t){e.handleFileChange(t)}}}),e._v(" "),a("el-form-item",{attrs:{label:"上传表格"}},[a("el-input",{attrs:{placeholder:"请选择需要上传的表格","prefix-icon":"el-icon-upload",clearable:"",readonly:""},model:{value:e.form.upload,callback:function(t){e.$set(e.form,"upload",t)},expression:"form.upload"}},[a("el-button",{attrs:{slot:"append"},on:{click:e.getFile},slot:"append"},[e._v("\n                                选择文件\n                            ")])],1)],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{type:"primary"},on:{click:function(t){e.upload(e.file)}}},[e._v("本地上传")])],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{disabled:e.isGetInfo,type:"success"},on:{click:e.handleClickVerify}},[e._v("数据校验")])],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{disabled:e.isVerify,type:"primary"},on:{click:e.handleClickImport}},[e._v("确认导入")])],1)],1),e._v(" "),a("div",{staticClass:"operation"},[a("el-form-item",{attrs:{label:"当前状态"}},[a("el-input",{attrs:{readonly:""},model:{value:e.state,callback:function(t){e.state=t},expression:"state"}})],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{type:"warning"},on:{click:e.handleClickRoll}},[e._v("数据回滚")])],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{disabled:e.isGetInfo,type:"danger"},on:{click:e.handleClickDel}},[e._v("批量删除")])],1),e._v(" "),a("el-form-item",[a("el-button",{attrs:{disabled:e.isGetInfo,type:"primary"},on:{click:e.handleClickBackups}},[e._v("数据备份")])],1),e._v(" "),a("el-form-item",[a("el-checkbox",{attrs:{disabled:e.isGetInfo},on:{change:e.handleChangeUnusual},model:{value:e.form.iserr,callback:function(t){e.$set(e.form,"iserr",t)},expression:"form.iserr"}},[e._v("仅显示异常")])],1)],1)])],1),e._v(" "),a("div",{staticClass:"table"},[a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.tableloading,expression:"tableloading"}],staticStyle:{width:"100%"},attrs:{data:e.tableData,stripe:"","max-height":"450",height:"450","element-loading-text":"拼命加载中"},on:{"selection-change":e.handleSelectionChange}},[a("el-table-column",{attrs:{type:"selection",width:"40"}}),e._v(" "),a("el-table-column",{attrs:{prop:"num",label:"序号","show-overflow-tooltip":""}}),e._v(" "),a("el-table-column",{attrs:{prop:"gddw",label:"供电单位","show-overflow-tooltip":""}}),e._v(" "),e._l(e.headArr,function(e){return a("el-table-column",{key:e.en,attrs:{prop:e.en,label:e.ch,"show-overflow-tooltip":""}})}),e._v(" "),a("el-table-column",{attrs:{fixed:"right",label:"操作",width:"80"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"danger",size:"small"},nativeOn:{click:function(a){a.preventDefault(),e.deleteRow(t.$index,e.tableData)}}},[e._v("\n                        删除\n                        ")])]}}])})],2),e._v(" "),a("p",{directives:[{name:"show",rawName:"v-show",value:e.isInfo,expression:"isInfo"}],staticClass:"result"},[e._v("当前成功导入"+e._s(e.sum)+"条，请校验")]),e._v(" "),a("p",{directives:[{name:"show",rawName:"v-show",value:!e.isInfo,expression:"!isInfo"}],staticClass:"result"},[e._v("共"+e._s(e.sum)+"条，其中"+e._s(e.abnormal)+"条存在异常")])],1),e._v(" "),a("div",{staticClass:"OI"},[a("div",{staticClass:"btns"},[a("el-button",{attrs:{size:"small",type:"primary",disabled:e.isGetInfo}},[e._v("刷新")]),e._v(" "),a("el-button",{attrs:{size:"small",type:"warning",disabled:e.isGetInfo},on:{click:e.clear}},[e._v("清屏")]),e._v(" "),a("el-button",{attrs:{size:"small",type:"primary",disabled:e.isGetInfo},on:{click:e.handleClickRecord}},[e._v("导出操作记录")])],1),e._v(" "),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.OIloading,expression:"OIloading"}],staticStyle:{width:"100%","margin-top":"10px"},attrs:{data:e.OIData,border:"","max-height":"150",height:"150","element-loading-text":"拼命加载中"}},[a("el-table-column",{attrs:{"show-overflow-tooltip":"",prop:"num",label:"编号"}}),e._v(" "),a("el-table-column",{attrs:{"show-overflow-tooltip":"",prop:"oper",label:"操作"}}),e._v(" "),a("el-table-column",{attrs:{"show-overflow-tooltip":"",prop:"errRow",label:"异常行数"}}),e._v(" "),a("el-table-column",{attrs:{"show-overflow-tooltip":"",prop:"errCell",label:"异常单元格"}}),e._v(" "),a("el-table-column",{attrs:{prop:"OI",label:"操作说明"}}),e._v(" "),a("el-table-column",{attrs:{"show-overflow-tooltip":"",prop:"handlers",label:"操作者"}}),e._v(" "),a("el-table-column",{attrs:{"show-overflow-tooltip":"",prop:"time",label:"操作时间"}})],1)],1)])])},[],!1,null,"0e38b6d5",null);m.options.__file="bulkImport.vue";t.default=m.exports},aICy:function(e,t,a){},xg5B:function(e,t,a){"use strict";var n=a("aICy");a.n(n).a}}]);